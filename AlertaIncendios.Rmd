
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"insigniaOK.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>

---
Format: ![Alt Text](url)

title: Sitios de conservación en potencial riesgo ante los incendios forestales actuales
author: "UNIDAD DE MONITOREO y PREDICCIÓN (COE GASP)"  
output: html_document
--- 

![](barra.jpg) 

##### **Fecha: ** `r format(Sys.time(), '%d %B, %Y')`  
##### **Hora: ** `r format(Sys.time(), '%H:%M')`
##### **Reporte N°: **1
***
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
  


```{r cars, results='hide',message = FALSE, warning = FALSE}

library(raster)
library(rgdal)
library(maptools)
library(sp)
library(geosphere)
library(rgeos)
library(rJava)
library(OpenStreetMap)
library(rjson)
library(leaflet)
library(XML)

## Funcion kml


## Descargar HotSpot 

# download.file("https://firms.modaps.eosdis.nasa.gov/data/active_fire/viirs/csv/VNP14IMGTDL_NRT_South_America_24h.csv" 
#               ,"modis", method="auto", quiet = FALSE, mode = "w",cacheOK = TRUE,extra = getOption("download.file.extra"))
# 
# download.file("https://firms.modaps.eosdis.nasa.gov/data/active_fire/c6/csv/MODIS_C6_South_America_24h.csv" 
#               ,"viirs", method="auto", quiet = FALSE, mode = "w",cacheOK = TRUE,extra = getOption("download.file.extra"))
# 
# modis<-read.csv("modis",sep=",",dec=".",header=T)
# viirs<-read.csv("viirs",sep=",",dec=".",header=T)
# coordinates(modis) <- ~longitude+latitude
# projection(modis) <- CRS("+proj=longlat +datum=WGS84")
# coordinates(viirs) <- ~longitude+latitude
# projection(viirs) <- CRS("+proj=longlat +datum=WGS84")

## Filtrar por limites nacionales

myShape <- readOGR("Data/Chile_continental.shp")
projection(myShape)<- CRS("+proj=longlat +datum=WGS84")

# st_mod <- modis[myShape, ]
# st_mod_utm<-spTransform(st_mod, CRS("+proj=utm +south +zone=19 +datum=WGS84"))
# st_vii <- viirs[myShape, ]
# st_vii_utm<-spTransform(st_vii, CRS("+proj=utm +south +zone=19 +datum=WGS84"))

## Cargar datos SIDCO

mySIDCO <- readOGR("data/sidco_06022018t.shp", encoding = "UTF-8")
projection(mySIDCO)<- CRS("+proj=longlat +datum=WGS84")
mySIDCO_utm<-spTransform(mySIDCO, CRS("+proj=utm +south +zone=19 +datum=WGS84"))

## Cargar coberturas de prioridad

mySC <- readOGR("data/Proteccion.shp", encoding = "UTF-8")
projection(mySC)<- CRS("+proj=longlat +datum=WGS84")
mySC_utm<-spTransform(mySC, CRS("+proj=utm +south +zone=19 +datum=WGS84"))

mySN<-subset(mySC,mySC@data$Tipoc=="SN")
myBNP<-subset(mySC,mySC@data$Tipoc=="BNP")
mySP<-subset(mySC,mySC@data$Tipoc=="SP")
myICP<-subset(mySC,mySC@data$Tipoc=="ICP")
myAAVC<-subset(mySC,mySC@data$Tipoc=="AAVC")
myASP<-subset(mySC,mySC@data$Tipoc=="SNASPE")

## Calcular distancia a...

# ## MODIS
# dist.mod<-as.data.frame(gDistance(myASP_utm, st_mod_utm,  byid=TRUE)) # filas son SNASPE y columnas hotspot
nSC<-mySC_utm@data[3]
# colnames(dist.mod)<-nASP[,1]
# dist.modis <- cbind(st_mod_utm@data, dist.mod)
# dist.modis <- cbind(st_mod@coords, dist.modis)
# dist.modis <- cbind(ID=row.names(dist.modis), dist.modis)
# name_asp<-as.data.frame(myASP)
# name_asp<-unique(name_asp$UNIDAD)
# 
# 
# sMODIS<-NULL
# for (i in 14:115){
#   d1<-subset(dist.modis,dist.modis[,i]<5000)
#   sMODIS<-rbind(sMODIS,d1)
# }
# 
# ## Viirs
# dist.vii<-as.data.frame(gDistance(myASP_utm, st_vii_utm,  byid=TRUE)) # filas son SNASPE y columnas hotspot
# colnames(dist.vii)<-nASP[,1]
# dist.viis <- cbind(st_vii_utm@data, dist.vii)
# dist.viis <- cbind(st_vii@coords, dist.viis)
# dist.viis <- cbind(ID=row.names(dist.viis), dist.viis)
# 
# sVIIRS<-NULL
# for (i in 14:115){
#   d1<-subset(dist.viis,dist.viis[,i]<5000)
#   sVIIRS<-rbind(sVIIRS,d1)
# }

## join de ubicacion

myRCP <- readOGR("data/union_rpc.shp", encoding = "UTF-8")
projection(myRCP)<- CRS("+proj=longlat +datum=WGS84")

rcp<-over(mySIDCO, myRCP)

## SIDCO
dist.SIDCO<-as.data.frame(gDistance(mySC_utm, mySIDCO_utm, byid=TRUE)) # filas son SNASPE y columnas hotspot
colnames(dist.SIDCO)<-nSC[,1]

dist.SIDCOs <- cbind(mySIDCO_utm@data, dist.SIDCO)
dist.SIDCOs <- cbind(rcp[2:5],dist.SIDCOs)
cord<-mySIDCO@coords[,1:2]
colnames(cord)<-c("longitude","latitude")
dist.SIDCOs <- cbind(cord, dist.SIDCOs)
dist.SIDCOs<- cbind(ID=row.names(dist.SIDCOs), dist.SIDCOs)

sSIDCOs<-NULL
for (i in 10:510){
  d1<-subset(dist.SIDCOs,dist.SIDCOs[,i]<5000)
  sSIDCOs<-rbind(sSIDCOs,d1)
}

datafin<-as.data.frame(sSIDCOs)
frecuen<-as.data.frame(summary(datafin$Name))
fre<-cbind(Name=row.names(frecuen),Frecuencia=frecuen$`summary(datafin$Name)`)
unicos<-unique(merge(datafin,fre,by="Name"))

resumen<-NULL

for (i in 1:dim(unicos)[1]){
  
  x<-unicos[i,]
  f<-as.numeric(as.character(x$Frecuencia))
  s<-sort(x[10:510])
  nSC2<-mySC@data[2:5]
  
  for (h in 1:f) {
    n1<-names(s[h])[which.min(apply(s[h],MARGIN=2,min))]
    n2<-subset(nSC2,nSC2$NAME==n1)
    n2<-as.character(n2$Tipoc)
    n3<-(s[h])[which.min(apply(s[h],MARGIN=2,min))]
    n3<-round(as.numeric(n3[1])/1000,2)
    nf<-cbind(x[1:9],Sitio=n1,Tipo=n2,"Distancia Foco (Km)"=n3)
    resumen<-rbind(resumen,nf)
}}

name1<-gsub('.*/(.*)','\\1',resumen$FolderPath)

compi<-cbind(Incendio=resumen[1],resumen[5:8],Estado=name1,resumen[10:12])
compi<-compi[order(compi$Orden, compi$`Distancia Foco (Km)`),]
compi<-compi[,-5]

spa<-cbind(Incendio=resumen[1],resumen[3:4],resumen[5:8],Estado=name1,resumen[10:12])


library(sp)
coordinates(spa)<-~longitude+latitude
projection(spa)<- CRS("+proj=longlat +datum=WGS84")

## Esta formula recodifica el texto 
  iconv.data.frame<-function (df, ...)
  {
    df.names <- iconv(names(df), ...)
    df.rownames <- iconv(rownames(df), ...)
    names(df) <- df.names
    rownames(df) <- df.rownames
    df.list <- lapply(df, function(x) {
      if (class(x) == "factor") {
        x <- factor(iconv(as.character(x), ...))
      }
      else if (class(x) == "character") {
        x <- iconv(x, ...)
      }
      else {
        x
      }
    })
    df.new <- do.call("data.frame", df.list)
    return(df.new)
  }
  
  compi<-iconv.data.frame(compi,from="UTF8",to="latin1")


```

#  
#  

#### El día de hoy se han detectado **`r format(length(unique(compi$Name)))`** focos de incendios que se encuentra a menos de 5 km de **`r format(length(unique(compi$Sitio)))`** sitios de conservación distribuidos en **`r format(length(unique(compi$Region)))`** regiones

***
#### Resumen de los sitios que actualmente presentan afectación potencial:  

```{r echo = FALSE,results="asis",message = FALSE, warning = FALSE}
library(knitr)
coln<-c("Foco","Región","Provincia","Comuna","Estado actual","Sitio","Tipo de protección","Distancia al foco (km)")
kable(compi, row.names = NA,col.names = coln)

```

***
**SNASPE** = Sistema Nacional de Áreas Silvestres Protegidas del Estado, 
**SN**     = Santuario de la Naturaleza, 
**BNP**    = Bien Nacional Protegido, 
**SP**     = Sitio Prioritario para la Conservación, 
**ICP**    = Iniciatica de Conservación Privada, 
**AAVC**   = Áreas de Alto Valor para la Conservación.
   
***
Escribe aquí tus comentarios:  

<textarea name="comentarios" rows="6" cols="130"></textarea>

## Mapa de distribución de focos registrados a menos de 5 km de Sitios de Conservasión:  

##  

```{r pressure, echo=FALSE}

  leaflet(width = 800, height = 600) %>% addProviderTiles(providers$Esri.WorldImagery) %>%
    addCircles(data = spa,radius = 5000 ,fill = T, fillOpacity = .05,stroke = TRUE, color = "#FF0000", 
               popup = paste("Foco: ", as.character(spa$Name)), group = "SIDCO") %>%
    #setView(lng1 = min(spa$longitude), lat1 = min(spa$latitude),lng2 = max(spa$longitude), lat2 = max(spa$latitude), zoom = 12) %>%
    addCircles(data = spa,radius = 5,fill = T,stroke = TRUE, color = "#FF0000") %>%
    addPolygons(data = myASP, fill = TRUE, color = "#12D502", 
                popup = paste(as.character(myASP@data[,2])," : ", as.character(myASP@data[,3])), group = "SNASPE") %>% 
    addPolygons(data = mySN, fill = TRUE, stroke = TRUE, color = "#0B6803", 
                popup = paste(as.character(mySN@data[,2])," : ", as.character(mySN@data[,3])), group = "SN") %>% 
    addPolygons(data = myBNP, fill = TRUE, stroke = TRUE, color = "#FCEE07", 
                popup = paste(as.character(myBNP@data[,2])," : ", as.character(myBNP@data[,3])), group = "BNP") %>% 
    addPolygons(data = mySP, fill = TRUE, stroke = TRUE, color = "#E2A904", 
                popup = paste(as.character(mySP@data[,2])," : ", as.character(mySP@data[,3])), group = "SP") %>% 
    addPolygons(data = myICP, fill = TRUE, stroke = TRUE, color = "#049BE2", 
                popup = paste(as.character(myICP@data[,2])," : ", as.character(myICP@data[,3])), group = "ICP") %>% 
    addPolygons(data = myAAVC, fill = TRUE, stroke = TRUE, color = "#E204D8", 
                popup = paste(as.character(myAAVC@data[,2])," : ", as.character(myAAVC@data[,3])), group = "AAVC") %>% 
  
  
    addLegend("bottomright", colors = c("#FF0000", "#12D502","#0B6803","#FCEE07","#E2A904","#049BE2","#E204D8"), labels = c("SIDCO radio: 5 km","SNASPE","SN","BNP","SP","ICP","AAVC")) %>%   
    addLayersControl(overlayGroups = c("SIDCO","SNASPE","SN","BNP","SP","ICP","AAVC"),options = layersControlOptions(collapsed = FALSE))
```

***

  
  