
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"insigniaOK.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>

---
Format: ![Alt Text](url)
title: Sitios de conservación en potencial riesgo ante los incendios forestales actuales
author: "UNIDAD DE MONITOREO y PREDICCIÓN (COE GASP)"  
output: html_document
--- 

![](barra.jpg) 

##### **Fecha: ** `r format(Sys.time(), '%d %B, %Y')`  
##### **Hora: ** `r format(Sys.time(), '%H:%M')`
##### **Reporte N°: **1
***
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
  


```{r cars, results='hide',message = FALSE, warning = FALSE}

library(raster)
library(rgdal)
library(maptools)
library(sp)
library(geosphere)
library(rgeos)
library(rJava)
library(OpenStreetMap)
library(rjson)
library(leaflet)
library(XML)

## Funcion kml


## Descargar HotSpot 

# download.file("https://firms.modaps.eosdis.nasa.gov/data/active_fire/viirs/csv/VNP14IMGTDL_NRT_South_America_24h.csv" 
#               ,"modis", method="auto", quiet = FALSE, mode = "w",cacheOK = TRUE,extra = getOption("download.file.extra"))
# 
# download.file("https://firms.modaps.eosdis.nasa.gov/data/active_fire/c6/csv/MODIS_C6_South_America_24h.csv" 
#               ,"viirs", method="auto", quiet = FALSE, mode = "w",cacheOK = TRUE,extra = getOption("download.file.extra"))
# 
# modis<-read.csv("modis",sep=",",dec=".",header=T)
# viirs<-read.csv("viirs",sep=",",dec=".",header=T)
# coordinates(modis) <- ~longitude+latitude
# projection(modis) <- CRS("+proj=longlat +datum=WGS84")
# coordinates(viirs) <- ~longitude+latitude
# projection(viirs) <- CRS("+proj=longlat +datum=WGS84")

## Filtrar por limites nacionales

myShape <- readOGR("Data/Chile_continental.shp")
projection(myShape)<- CRS("+proj=longlat +datum=WGS84")

# st_mod <- modis[myShape, ]
# st_mod_utm<-spTransform(st_mod, CRS("+proj=utm +south +zone=19 +datum=WGS84"))
# st_vii <- viirs[myShape, ]
# st_vii_utm<-spTransform(st_vii, CRS("+proj=utm +south +zone=19 +datum=WGS84"))

## Cargar datos SIDCO

mySIDCO <- readOGR("Data/sidco.shp")
projection(mySIDCO)<- CRS("+proj=longlat +datum=WGS84")
mySIDCO_utm<-spTransform(mySIDCO, CRS("+proj=utm +south +zone=19 +datum=WGS84"))

## Cargar coberturas de prioridad

myASP <- readOGR("data/Proteccion.shp")
projection(myASP)<- CRS("+proj=longlat +datum=WGS84")
myASP_utm<-spTransform(myASP, CRS("+proj=utm +south +zone=19 +datum=WGS84"))

## Calcular distancia a...

# ## MODIS
# dist.mod<-as.data.frame(gDistance(myASP_utm, st_mod_utm,  byid=TRUE)) # filas son SNASPE y columnas hotspot
nASP<-myASP_utm@data[3]
# colnames(dist.mod)<-nASP[,1]
# dist.modis <- cbind(st_mod_utm@data, dist.mod)
# dist.modis <- cbind(st_mod@coords, dist.modis)
# dist.modis <- cbind(ID=row.names(dist.modis), dist.modis)
# name_asp<-as.data.frame(myASP)
# name_asp<-unique(name_asp$UNIDAD)
# 
# 
# sMODIS<-NULL
# for (i in 14:115){
#   d1<-subset(dist.modis,dist.modis[,i]<5000)
#   sMODIS<-rbind(sMODIS,d1)
# }
# 
# ## Viirs
# dist.vii<-as.data.frame(gDistance(myASP_utm, st_vii_utm,  byid=TRUE)) # filas son SNASPE y columnas hotspot
# colnames(dist.vii)<-nASP[,1]
# dist.viis <- cbind(st_vii_utm@data, dist.vii)
# dist.viis <- cbind(st_vii@coords, dist.viis)
# dist.viis <- cbind(ID=row.names(dist.viis), dist.viis)
# 
# sVIIRS<-NULL
# for (i in 14:115){
#   d1<-subset(dist.viis,dist.viis[,i]<5000)
#   sVIIRS<-rbind(sVIIRS,d1)
# }

## join de ubicacion

myRCP <- readOGR("Data/union_rpc.shp")
projection(myRCP)<- CRS("+proj=longlat +datum=WGS84")

rcp<-over(mySIDCO, myRCP)

## SIDCO
dist.SIDCO<-as.data.frame(gDistance(myASP_utm, mySIDCO_utm, byid=TRUE)) # filas son SNASPE y columnas hotspot
colnames(dist.SIDCO)<-nASP[,1]
dist.SIDCOs <- cbind(mySIDCO_utm@data[2:3], dist.SIDCO)
dist.SIDCOs <- cbind(rcp[2:4],dist.SIDCOs)
cord<-mySIDCO@coords[,1:2]
colnames(cord)<-c("longitude","latitude")
dist.SIDCOs <- cbind(cord, dist.SIDCOs)
dist.SIDCOs<- cbind(ID=row.names(dist.SIDCOs), dist.SIDCOs)

sSIDCOs<-NULL
for (i in 6:106){
  d1<-subset(dist.SIDCOs,dist.SIDCOs[,i]<5000)
  sSIDCOs<-rbind(sSIDCOs,d1)
}

resumen<-NULL

for (i in 1:dim(sSIDCOs)[1]){
  ## para nombre de sitio
  n1<-names(sSIDCOs[i,9:509])[which.min(apply(sSIDCOs[i,9:509],MARGIN=2,min))]
  ## para tipo de sitio
  nASP2<-myASP@data[2:3]
  n2<-subset(nASP2,nASP2$NAME==n1)
  n2<-as.character(n2$TIPO)
  ## para distancia
  n3<-(sSIDCOs[i,9:509])[which.min(apply(sSIDCOs[i,9:509],MARGIN=2,min))]
  n3<-as.numeric(n3[1])/1000
  nf<-cbind(n1,n2,n3)
  resumen<-rbind(resumen,nf)
}

colnames(resumen)<-c("Nombre","Tipo","DistFoco")
resumen<-as.data.frame(resumen)

sidcors<-sSIDCOs[,2:3]

library(sp)
coordinates(sSIDCOs)<-~longitude+latitude
projection(sSIDCOs)<- CRS("+proj=longlat +datum=WGS84")

focos<-dim(sSIDCOs)[1]
datafin<-as.data.frame(sSIDCOs)

```

#  
#  

#### El día de hoy se han detectado **`r format(length(unique(datafin$Name)))`** focos de incendios que se encuentra a menos de 5 km de **`r format(length(unique(datafin$Name)))`** sitios de conservación distribuidos en **`r format(length(unique(datafin$Region)))`** regiones

***
#### Resumen de los sitios que actualmente presentan afectación potencial:  
  
  
| Foco | Sitio en riesgo | Tipo de protección | Región | Provincia | Comuna | Distancia al foco (km) | Aspectos relevantes|
|:---------------|:-------------:|---------------:|:-------------:|---------------:|:-------------:|---------------:|:-------------:|
| `r format(datafin$Name[1])`| `r format(resumen$Tipo[1])` | `r format(resumen$Nombre[1])` |`r format(datafin$Region[1])` |`r format(datafin$Provincia[1])` | `r format(datafin$Comuna[1])` | `r format(resumen$DistFoco[1])`|||
| `r format(datafin$Name[2])` | proteccion | Nombre |`r format(datafin$Region[2])`|`r format(datafin$Provincia[2])` | `r format(datafin$Comuna[2])` | |||
| `r format(datafin$Name[3])` | proteccion | Nombre |`r format(datafin$Region[3])`|`r format(datafin$Provincia[3])` | `r format(datafin$Comuna[3])` | |||
| `r format(datafin$Name[4])` | proteccion | Nombre |`r format(datafin$Region[4])`|`r format(datafin$Provincia[4])` | `r format(datafin$Comuna[4])` | |||
| `r format(datafin$Name[5])` | proteccion | Nombre |`r format(datafin$Region[5])`|`r format(datafin$Provincia[5])` | `r format(datafin$Comuna[5])` | |||
| `r format(datafin$Name[6])` | proteccion | Nombre |`r format(datafin$Region[6])`|`r format(datafin$Provincia[6])` | `r format(datafin$Comuna[6])` | |||
| `r format(datafin$Name[7])` | proteccion | Nombre |`r format(datafin$Region[7])`|`r format(datafin$Provincia[7])` | `r format(datafin$Comuna[7])` | |||
| `r format(datafin$Name[8])` | proteccion | Nombre |`r format(datafin$Region[8])`|`r format(datafin$Provincia[8])` | `r format(datafin$Comuna[8])` | |||
| `r format(datafin$Name[8])` | proteccion | Nombre |`r format(datafin$Region[9])`|`r format(datafin$Provincia[9])` | `r format(datafin$Comuna[9])` | |||

***

## Mapa de distribución de focos registrados  
  
  **Incendio `r format(datafin$Name[1])`**


```{r pressure, echo=FALSE}

  i=1
  leaflet() %>% addProviderTiles(providers$Esri.WorldImagery) %>%
    addCircles(data = sSIDCOs[i,],radius = 5000 ,fill = T, fillOpacity = .05,stroke = TRUE, color = "#FF0000", 
               popup = paste0("Name: ", as.character(sSIDCOs$Name[i])), group = "SIDCO") %>%
    setView(lng = mean(sidcors$longitude[i]), lat = mean(sidcors$latitude[i]), zoom = 11) %>%
    addCircles(data = sSIDCOs[i,],radius = 5,fill = T,stroke = TRUE, color = "#FF0000") %>%
    addPolygons(data = myASP, fill = TRUE, stroke = TRUE, color = "#36FF33", 
                popup = paste0(as.character(myASP@data[,2]),"Unidad: ", as.character(myASP@data[,3])), group = "ASP") %>% 
    addLegend("bottomright", colors = c("#FF0000", "#36FF33"), labels = c("SIDCO 5 km", "ASP")) %>%   
    addLayersControl(overlayGroups = c("SIDCO","ASP"),options = layersControlOptions(collapsed = FALSE))
```

***
  **Incendio `r format(datafin$Name[2])`**  
    
    
  
```{r,echo=FALSE}
  i=2
  leaflet() %>% addProviderTiles(providers$Esri.WorldImagery) %>%
    addCircles(data = sSIDCOs[i,],radius = 5000 ,fill = T, fillOpacity = .05,stroke = TRUE, color = "#FF0000", 
               popup = paste0("Name: ", as.character(sSIDCOs$Name[i])), group = "SIDCO") %>%
    setView(lng = mean(sidcors$longitude[i]), lat = mean(sidcors$latitude[i]), zoom = 11) %>%
    addCircles(data = sSIDCOs[i,],radius = 5,fill = T,stroke = TRUE, color = "#FF0000") %>%
    addPolygons(data = myASP, fill = TRUE, stroke = TRUE, color = "#36FF33", 
                popup = paste0(as.character(myASP@data[,2]),"Unidad: ", as.character(myASP@data[,3])), group = "ASP") %>% 
    addLegend("bottomright", colors = c("#FF0000", "#36FF33"), labels = c("SIDCO 5 km", "ASP")) %>%   
    addLayersControl(overlayGroups = c("SIDCO","ASP"),options = layersControlOptions(collapsed = FALSE))
```
  

  
  